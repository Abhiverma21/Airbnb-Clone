<% layout('/layouts/boilerplate') -%>

<div class="container py-5">
  <!-- USER PROFILE SECTION -->
  <div class="row mb-5">
    <div class="col-12 col-lg-4 mb-4">
      <div class="card text-center shadow-sm border-0 p-4">
        <div
          class="avatar-lg mx-auto mb-3"
          style="
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #ff385c;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: 700;
          "
        >
          <%= user.username.charAt(0).toUpperCase() %>
        </div>
        <h3 class="fw-semibold mb-1 text-capitalize"><%= user.username %></h3>
        <p class="text-muted mb-2">
          <i class="bi bi-envelope"></i> <%= user.email %>
        </p>
        <p class="small text-muted">
          Joined on: <%= user.createdAt ? new Date(user.createdAt).toLocaleDateString() : (user._id ? new Date(user._id.getTimestamp()).toLocaleDateString() : "N/A") %>
        </p>

        <hr class="my-3" />

        <div class="d-flex justify-content-around mb-3">
          <div>
            <h5 class="fw-bold mb-0"><%= listings.length %></h5>
            <p class="text-muted small">Listings</p>
          </div>
          <div>
            <h5 class="fw-bold mb-0"><%= user.favorites ? user.favorites.length : 0 %></h5>
            <p class="text-muted small">Favorites</p>
          </div>
          <div>
            <h5 class="fw-bold mb-0">0</h5>
            <p class="text-muted small">Reviews</p>
          </div>
        </div>

        <a href="/listings/new" class="btn btn-sm w-100 mb-2" style="background-color: #ff385c; color: white;">
          <i class="bi bi-plus-circle"></i> Create New Listing
        </a>
       
      </div>
    </div>

    <!-- LISTINGS AND FAVORITES SECTION -->
    <div class="col-12 col-lg-8">
      <ul class="nav nav-tabs mb-4" id="profileTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="listings-tab" data-bs-toggle="tab" data-bs-target="#listings" type="button" role="tab">
            My Listings <span class="badge bg-secondary ms-1"><%= listings.length %></span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="favorites-tab" data-bs-toggle="tab" data-bs-target="#favorites" type="button" role="tab">
            Favorites <span class="badge bg-secondary ms-1"><%= user.favorites ? user.favorites.length : 0 %></span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings" type="button" role="tab">
            Bookings <span class="badge bg-secondary ms-1"><%= bookings ? bookings.length : 0 %></span>
          </button>
        </li>
      </ul>

      <div class="tab-content" id="profileTabsContent">
        <!-- My Listings Tab -->
        <div class="tab-pane fade show active" id="listings" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-semibold">My Listings</h3>
        <div class="d-flex gap-2">
          <input
            type="text"
            class="form-control form-control-sm"
            id="searchInput"
            placeholder="Search listings..."
          />
          <select id="sortSelect" class="form-select form-select-sm">
            <option value="recent">Most Recent</option>
            <option value="priceHigh">Price: High to Low</option>
            <option value="priceLow">Price: Low to High</option>
          </select>
        </div>
      </div>

      <% if (listings.length === 0) { %>
      <div class="alert alert-info text-center py-4 shadow-sm">
        <h5 class="mb-1">You don't have any listings yet!</h5>
        <p class="small mb-3">
          Start sharing your first property and attract guests today.
        </p>
        <a href="/listings/new" class="btn btn-sm" style="border-color: #ff385c; color: #ff385c;">
          <i class="bi bi-plus-lg"></i> Create Listing
        </a>
      </div>
      <% } else { %>
      <div class="row g-4" id="listingContainer">
        <% listings.forEach(listing => { %>
        <div class="col-12 col-sm-6 col-lg-6 listing-card">
          <div class="card h-100 border-0 shadow-sm hover-shadow">
            <img
              src="<%= listing.image?.url || '/images/placeholder.png' %>"
              class="card-img-top"
              alt="<%= listing.title %>"
              style="
                height: 180px;
                object-fit: cover;
                border-radius: 12px 12px 0 0;
              "
            />
            <div class="card-body d-flex flex-column">
              <h5 class="card-title fw-semibold text-truncate">
                <%= listing.title %>
              </h5>
              <p class="text-muted mb-2 small">
                <i class="bi bi-geo-alt"></i> <%= listing.location %>
              </p>
              <p class="fw-bold mb-2" style="color: #ff385c;">
                ₹<%= listing.price.toLocaleString('en-IN') %> / night
              </p>
              <p class="text-muted small flex-grow-1">
                <%= listing.description.substring(0, 80) %>...
              </p>

              <div
                class="d-flex justify-content-between align-items-center mt-3"
              >
                <a
                  href="/listings/<%= listing._id %>"
                  class="btn btn-sm"
                  style="background-color: #ff385c; color: white;"
                >
                  <i class="bi bi-eye"></i> View
                </a>
                <div>
                  <a
                    href="/listings/<%= listing._id %>/edit"
                    class="btn btn-outline-secondary btn-sm me-1"
                  >
                    <i class="bi bi-pencil-square">Edit</i>
                  </a>
                  <form
                    action="/listings/<%= listing._id %>?_method=DELETE"
                    method="post"
                    class="d-inline"
                  >
                    <button class="btn btn-outline-danger btn-sm">
                      <i class="bi bi-trash">Delete</i>
                    </button>
                  </form>
                </div>
              </div>
              <hr class="mt-3 mb-1" />
              <div class="d-flex justify-content-between text-muted small">
                <span><i class="bi bi-eye-fill"></i> 0 views</span>
                <span
                  ><i class="bi bi-heart-fill text-danger"></i> 0 likes</span
                >
              </div>
            </div>
          </div>
        </div>
        <% }) %>
      </div>
      <% } %>
        </div>

        <!-- Favorites Tab -->
        <div class="tab-pane fade" id="favorites" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-semibold">My Favorites</h3>
            <div class="d-flex gap-2">
              <input
                type="text"
                class="form-control form-control-sm"
                id="favSearchInput"
                placeholder="Search favorites..."
              />
              <select id="favSortSelect" class="form-select form-select-sm">
                <option value="recent">Most Recent</option>
                <option value="priceHigh">Price: High to Low</option>
                <option value="priceLow">Price: Low to High</option>
              </select>
            </div>
          </div>

          <% if (!user.favorites || user.favorites.length === 0) { %>
          <div class="alert alert-info text-center py-4 shadow-sm">
            <h5 class="mb-1">No favorites yet!</h5>
            <p class="small mb-3">
              Start exploring listings and save your favorites.
            </p>
            <a href="/listings" class="btn btn-sm" style="border-color: #ff385c; color: #ff385c;">
              <i class="bi bi-search"></i> Browse Listings
            </a>
          </div>
          <% } else { %>
          <div class="row g-4" id="favoriteContainer">
            <% user.favorites.forEach(favorite => { %>
            <div class="col-12 col-sm-6 col-lg-6 favorite-card">
              <div class="card h-100 border-0 shadow-sm hover-shadow">
                <img
                  src="<%= favorite.image?.url || '/images/placeholder.png' %>"
                  class="card-img-top"
                  alt="<%= favorite.title %>"
                  style="height: 180px; object-fit: cover; border-radius: 12px 12px 0 0;"
                />
                <div class="card-body d-flex flex-column">
                  <h5 class="card-title fw-semibold text-truncate">
                    <%= favorite.title %>
                  </h5>
                  <p class="text-muted mb-2 small">
                    <i class="bi bi-geo-alt"></i> <%= favorite.location %>
                  </p>
                  <p class="fw-bold mb-2" style="color: #ff385c;">
                    ₹<%= favorite.price.toLocaleString('en-IN') %> / night
                  </p>
                  <p class="text-muted small flex-grow-1">
                    <%= favorite.description.substring(0, 80) %>...
                  </p>

                  <div class="d-flex justify-content-between align-items-center mt-3">
                    <a
                      href="/listings/<%= favorite._id %>"
                      class="btn btn-sm"
                      style="background-color: #ff385c; color: white;"
                    >
                      <i class="bi bi-eye"></i> View
                    </a>
                    <button
                      class="btn btn-sm btn-outline-danger remove-favorite"
                      data-listing-id="<%= favorite._id %>"
                    >
                      <i class="bi bi-heart-fill"></i> Remove
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <% }) %>
          </div>
          <% } %>
        </div>
        
        <!-- Bookings Tab -->
        <div class="tab-pane fade" id="bookings" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-semibold">My Bookings</h3>
          </div>

          <% if (!bookings || bookings.length === 0) { %>
            <div class="alert alert-info text-center py-4 shadow-sm">
              <h5 class="mb-1">No bookings yet!</h5>
              <p class="small mb-3">Your confirmed bookings will appear here.</p>
              <a href="/listings" class="btn btn-sm" style="border-color: #ff385c; color: #ff385c;">Browse Listings</a>
            </div>
          <% } else { %>
            <div class="list-group">
              <% bookings.forEach(b => { %>
                <div class="list-group-item mb-3">
                  <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1"><a href="/listings/<%= b.listing._id %>"><%= b.listing.title %></a></h5>
                      <small class="text-muted"><%= new Date(b.createdAt).toLocaleString() %></small>
                    </div>
                  <p class="mb-1 text-muted">Dates: <%= new Date(b.checkin).toLocaleDateString() %> — <%= new Date(b.checkout).toLocaleDateString() %></p>
                  <p class="mb-1">Guests: <%= b.guests %> | Total: ₹<%= b.total ? b.total.toLocaleString('en-IN') : '0' %> | Status: <%= b.status %></p>
                  <p class="mb-1 small text-muted">Contact: <%= b.contactName %> — <%= b.contactEmail %> — <%= b.contactPhone %></p>
                  <div class="mt-2">
                    <button class="btn btn-sm btn-danger delete-booking" data-id="<%= b._id %>">Delete</button>
                  </div>
                </div>
              <% }) %>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="/profile" class="p-0" novalidate>
        <input type="hidden" name="_method" value="PUT">
        <div class="modal-body">
          <div class="mb-3">
            <label for="editUsername" class="form-label">Username</label>
            <input type="text" class="form-control" id="editUsername" name="user[username]" value="<%= user.username %>" required>
          </div>
          <div class="mb-3">
            <label for="editEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="editEmail" name="user[email]" value="<%= user.email %>" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" style="background-color: #ff385c;">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ========== CLIENT-SIDE SEARCH & SORT SCRIPT ========== -->
<script>
  // Listings Search and Sort
  const searchInput = document.getElementById("searchInput");
  const sortSelect = document.getElementById("sortSelect");
  const listingContainer = document.getElementById("listingContainer");

  searchInput?.addEventListener("input", () => {
    const query = searchInput.value.toLowerCase();
    document.querySelectorAll(".listing-card").forEach((card) => {
      const title = card.querySelector(".card-title").textContent.toLowerCase();
      card.style.display = title.includes(query) ? "" : "none";
    });
  });

  sortSelect?.addEventListener("change", () => {
    const cards = Array.from(document.querySelectorAll(".listing-card"));
    const value = sortSelect.value;

    cards.sort((a, b) => {
      const priceA = parseFloat(
        a.querySelector(".fw-bold").textContent.replace(/[^\d]/g, "")
      );
      const priceB = parseFloat(
        b.querySelector(".fw-bold").textContent.replace(/[^\d]/g, "")
      );
      return value === "priceHigh"
        ? priceB - priceA
        : value === "priceLow"
        ? priceA - priceB
        : 0;
    });

    listingContainer.innerHTML = "";
    cards.forEach((c) => listingContainer.appendChild(c));
  });

  // Favorites Search and Sort
  const favSearchInput = document.getElementById("favSearchInput");
  const favSortSelect = document.getElementById("favSortSelect");
  const favoriteContainer = document.getElementById("favoriteContainer");

  favSearchInput?.addEventListener("input", () => {
    const query = favSearchInput.value.toLowerCase();
    document.querySelectorAll(".favorite-card").forEach((card) => {
      const title = card.querySelector(".card-title").textContent.toLowerCase();
      card.style.display = title.includes(query) ? "" : "none";
    });
  });

  favSortSelect?.addEventListener("change", () => {
    const cards = Array.from(document.querySelectorAll(".favorite-card"));
    const value = favSortSelect.value;

    cards.sort((a, b) => {
      const priceA = parseFloat(
        a.querySelector(".fw-bold").textContent.replace(/[^\d]/g, "")
      );
      const priceB = parseFloat(
        b.querySelector(".fw-bold").textContent.replace(/[^\d]/g, "")
      );
      return value === "priceHigh"
        ? priceB - priceA
        : value === "priceLow"
        ? priceA - priceB
        : 0;
    });

    favoriteContainer.innerHTML = "";
    cards.forEach((c) => favoriteContainer.appendChild(c));
  });

  // Handle Remove Favorite
  document.querySelectorAll(".remove-favorite").forEach(btn => {
    btn.addEventListener("click", async function() {
      const listingId = this.dataset.listingId;
      try {
        const response = await fetch(`/listings/${listingId}/favorite`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          // Remove the card from the UI
          this.closest('.favorite-card').remove();
          
          // Update the favorites count
          const favCount = document.querySelectorAll('.favorite-card').length;
          document.querySelector('#favorites-tab .badge').textContent = favCount;
          
          if (favCount === 0) {
            // Show empty state if no favorites remain
            favoriteContainer.innerHTML = `
              <div class="alert alert-info text-center py-4 shadow-sm">
                <h5 class="mb-1">No favorites yet!</h5>
                <p class="small mb-3">
                  Start exploring listings and save your favorites.
                </p>
                <a href="/listings" class="btn btn-sm" style="border-color: #ff385c; color: #ff385c;">
                  <i class="bi bi-search"></i> Browse Listings
                </a>
              </div>
            `;
          }
        }
      } catch (err) {
        console.error("Error removing favorite:", err);
      }
    });
  });

  // Handle Delete Booking
  document.querySelectorAll('.delete-booking').forEach(btn => {
    btn.addEventListener('click', async function() {
      const id = this.dataset.id;
      if (!confirm('Are you sure you want to delete this booking?')) return;
      const button = this;
      button.disabled = true;
      const originalText = button.textContent;
      button.textContent = 'Deleting...';
      try {
        const res = await fetch(`/api/bookings/${id}`, { method: 'DELETE', credentials: 'same-origin' });
        let data;
        try { data = await res.json(); } catch(e) { data = null; }
        if (!res.ok) {
          const msg = data && data.error ? data.error : `Server returned ${res.status}`;
          alert('Could not delete booking: ' + msg);
          button.disabled = false;
          button.textContent = originalText;
          return;
        }
        if (!data || !data.success) {
          alert('Could not delete booking: ' + (data && data.error ? data.error : 'Unknown'));
          button.disabled = false;
          button.textContent = originalText;
          return;
        }
        // Remove from UI
        const item = this.closest('.list-group-item');
        if (item) item.remove();
        // Update badge count
        const badge = document.querySelector('#bookings-tab .badge');
        if (badge) badge.textContent = Math.max(0, Number(badge.textContent) - 1);
      } catch (err) {
        console.error('Delete booking error', err);
        alert('Error deleting booking: ' + err.message);
        button.disabled = false;
        button.textContent = originalText;
      }
    });
  });
</script>

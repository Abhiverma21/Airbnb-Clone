<% layout("/layouts/boilerplate") -%>

<style>
  /* ---------- GLOBAL ---------- */
  body {
    background-color: #f5f5f7;
    font-family: "Poppins", sans-serif;
    color: #333;
    margin: 0;
    padding: 0;
  }

  /* ---------- CONTAINER ---------- */
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px 15px;
    box-sizing: border-box;
  }

  /* ---------- HEADER ---------- */
  .listing-header {
    text-align: center;
    margin-top: 30px;
  }
  .listing-header h1 {
    font-weight: 700;
    color: #222;
    font-size: 2rem;
  }
  .listing-header p {
    color: #666;
    font-size: 1rem;
    margin-top: 5px;
  }

  /* ---------- FLEX MAIN ---------- */
  .flex-main {
    display: flex;
    gap: 30px;
    margin-top: 30px;
    align-items: flex-start;
  }

  /* LEFT SIDE: IMAGE + DETAILS */
  .left-side {
    flex: 1;
    max-width: 50%;
  }
  .show-card {
    background-color: #fff;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 20px;
  }
  .show-img {
    width: 100%;
    height: 400px;
    object-fit: cover;
    border-radius: 20px 20px 0 0;
  }
  .card-body {
    padding: 25px;
  }
  .card-body p {
    margin-bottom: 12px;
  }
  .owner {
    font-weight: 600;
    color: #333;
  }
  .description {
    color: #555;
    line-height: 1.6;
    margin-top: 15px;
  }
  .price-highlight {
    font-size: 1rem;
    font-weight: 700;
    color: #ff385c;
    margin-top: 15px;
  }
  .rating {
    margin-top: 10px;
    font-size: 0.95rem;
    color: #444;
  }
  .rating i {
    color: #ffd700;
  }

  /* ---------- BUTTONS ---------- */
  .btns {
    display: flex;
    gap: 15px;
    margin: 20px 0;
    flex-wrap: wrap;
  }
  .btns a,
  .btns button {
    border-radius: 30px;
    padding: 10px 22px;
    font-weight: 600;
    transition: all 0.3s ease;
    text-decoration: none;
  }
  .btns a:hover,
  .btns button:hover {
    opacity: 0.85;
  }
  .book-now-btn {
    background-color: #ff385c;
    color: #fff;
    border: none;
  }
  .book-now-btn:hover {
    background-color: #e12e50;
  }

  /* RIGHT SIDE: REVIEW FORM + CARDS */
  .right-side {
    flex: 1;
    max-width: 50%;
  }

  /* REVIEW FORM */
  .review-form-card {
    background-color: #fff;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    margin-bottom: 30px;
  }
  .review-form-card h4 {
    margin-bottom: 15px;
  }
  .review-form-card textarea {
    resize: none;
  }

  /* STAR RATINGS FORM */
  .star-rating {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
    gap: 5px;
  }

  .star-rating input {
    display: none; /* hide radio buttons */
  }

  .star-rating label {
    font-size: 2rem;
    color: #ccc;
    cursor: pointer;
    transition: color 0.2s;
  }

  /* Hover effect */
  .star-rating label:hover,
  .star-rating label:hover ~ label {
    color: gold;
  }

  /* Checked (selected) stars stay highlighted */
  .star-rating input:checked ~ label {
    color: gold;
  }

  /* REVIEW CARDS */
  .reviews-container {
    display: flex;
    gap: 15px;
    padding-bottom: 10px;
    scroll-behavior: smooth;
  }
  .reviews-container.logged-in {
    overflow-x: auto;
    flex-wrap: nowrap;
  }
  .reviews-container:not(.logged-in) {
    flex-wrap: wrap;
  }
  .review-card {
    flex: 0 0 300px;
    background-color: #fff;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
    display: flex;
    flex-direction: column;
    gap: 12px;
    transition: transform 0.2s ease;
  }
  .reviews-container:not(.logged-in) .review-card {
    flex: 0 0 calc(50% - 15px);
  }
  .review-card:hover {
    transform: translateY(-3px);
  }
  .review-header {
    display: flex;
    align-items: center;
    gap: 10px;
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 10px;
  }
  .avatar {
    width: 40px;
    height: 40px;
    background-color: #ff385c;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
  }
  .review-card .username {
    font-weight: 600;
    color: #333;
    margin-bottom: 0;
  }
  .review-card .stars {
    display: flex;
    gap: 2px;
  }
  .review-card .stars i {
    color: #ffd700;
    font-size: 0.9rem;
  }
  .review-card .stars i.gray {
    color: #ccc;
  }
  .review-card .comment {
    color: #555;
    font-size: 0.95rem;
    line-height: 1.6;
    border-left: 3px solid #ff385c;
    padding-left: 12px;
    margin: 0;
  }
  .review-card form button {
    align-self: flex-end;
    margin-top: auto;
  }

  /* ---------- RESPONSIVE ---------- */
  @media screen and (max-width: 1024px) {
    .show-img {
      height: 350px;
    }
  }
  @media screen and (max-width: 768px) {
    .flex-main {
      flex-direction: column;
      gap: 20px;
    }
    .left-side,
    .right-side {
      max-width: 100%;
      width: 100%;
    }
    .show-img {
      height: 250px;
    }
    .review-card {
      flex: 0 0 100%;
    }
    .review-form-card {
      width: 100%;
    }
    .btns {
      flex-direction: column;
      align-items: center;
    }
  }
  @media screen and (max-width: 480px) {
    .show-img {
      height: 200px;
    }
    .card-body {
      padding: 20px 15px;
    }
    .review-form-card {
      margin-bottom: 20px;
    }
  }
</style>

<body>
  <div class="container">
    <!-- Header -->
    <div class="listing-header">
      <h1><%= listing.title %></h1>
      <p>
        <i class="fa-solid fa-location-dot" style="color: #ff385c"></i> <%=
        listing.location %>, <%= listing.country %>
      </p>
    </div>

    <!-- FLEX MAIN -->
    <div class="flex-main">
      <!-- LEFT SIDE -->
      <div class="left-side">
        <div class="show-card">
          <img
            src="<%= listing.image.url %>"
            class="show-img"
            alt="<%= listing.title %>"
          />
          <div class="card-body">
            <p class="owner">Hosted by <b><%= listing.owner.username %></b></p>
            <p class="description">Description: <%= listing.description %></p>
            <p class="price-highlight">
              ₹<%= listing.price.toLocaleString("en-IN") %> / night
            </p>
          </div>
        </div>

        <!-- Buttons -->
        <div class="btns">
          <% if(currUser && listing.owner._id.equals(currUser._id)) { %>
          <a href="/listings/<%=listing.id%>/edit" class="btn btn-dark"
            >Edit Listing</a
          >
          <form method="post" action="/listings/<%=listing.id%>?_method=DELETE">
            <button class="btn btn-outline-dark">Delete Listing</button>
          </form>
          <% } %> <% if(currUser && !listing.owner._id.equals(currUser._id)) {
          %>
          <button
            class="btn <%= currUser.favorites && currUser.favorites.includes(listing._id) ? 'btn-danger' : 'btn-outline-danger' %> favorite-btn"
            data-listing-id="<%= listing._id %>"
            onclick="toggleFavorite(this)"
          >
            <i
              class="bi bi-heart<%= currUser.favorites && currUser.favorites.includes(listing._id) ? '-fill' : '' %>"
            ></i>
            <%= currUser.favorites && currUser.favorites.includes(listing._id) ?
            'Remove from Favorites' : 'Add to Favorites' %>
          </button>
          <% } %>

          <a href="/listings/<%= listing._id %>/book" class="btn book-now-btn"
            >Book Now</a
          >
        </div>
      </div>

      <!-- RIGHT SIDE -->
      <div class="right-side">
        <% if(currUser) { %>
        <div class="review-form-card">
          <h4>Share Your Experience</h4>
          <form action="/listings/<%=listing._id%>/reviews" method="post">
            <div class="mb-3">
              <label>Rating:</label>
              <div class="star-rating">
                <% for (let i = 5; i >= 1; i--) { %>
                <input
                  type="radio"
                  id="star<%=i%>"
                  name="review[rating]"
                  value="<%=i%>"
                />
                <label for="star<%=i%>">★</label>
                <% } %>
              </div>
            </div>
            <div class="mb-3">
              <label for="comment">Your Review:</label>
              <textarea
                id="comment"
                name="review[comment]"
                rows="4"
                class="form-control"
                required
              ></textarea>
            </div>
            <button class="btn btn-dark">Submit Review</button>
          </form>
        </div>
        <% } %>

        <h4>All Reviews</h4>
        <div class="reviews-container <%= currUser ? 'logged-in' : '' %>">
          <% if(listing.reviews.length === 0) { %>
          <p class="text-muted">
            No reviews yet. Be the first to share your experience!
          </p>
          <% } else { %> <% for(let review of listing.reviews){ %>
          <div class="review-card">
            <div class="review-header">
              <div class="avatar">
                <%= review.author.username.charAt(0).toUpperCase() %>
              </div>
              <div>
                <p class="username">@<%= review.author.username %></p>
                <div class="stars">
                  <% for(let i=1;i<=5;i++){ %> <% if(i <= review.rating){ %>
                  <i class="fa-solid fa-star"></i>
                  <% } else { %>
                  <i class="fa-solid fa-star gray"></i>
                  <% } %> <% } %>
                </div>
              </div>
            </div>
            <p class="comment"><%= review.comment %></p>
            <% if(currUser && review.author._id.equals(currUser._id)) { %>
            <form
              action="/listings/<%=listing.id%>/reviews/<%=review.id%>?_method=DELETE"
              method="post"
            >
              <button class="btn btn-outline-dark btn-sm">Delete</button>
            </form>
            <% } %>
          </div>
          <% } %> <% } %>
        </div>
      </div>
    </div>
  </div>
  <script>
    async function toggleFavorite(button) {
      const listingId = button.dataset.listingId;
      try {
        const response = await fetch(`/listings/${listingId}/favorite`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        });

        if (response.ok) {
          const data = await response.json();
          // Update button appearance
          if (data.isFavorite) {
            button.classList.remove("btn-outline-danger");
            button.classList.add("btn-danger");
            button.querySelector("i").classList.add("bi-heart-fill");
            button.querySelector("i").classList.remove("bi-heart");
            button.textContent = " Remove from Favorites";
          } else {
            button.classList.add("btn-outline-danger");
            button.classList.remove("btn-danger");
            button.querySelector("i").classList.remove("bi-heart-fill");
            button.querySelector("i").classList.add("bi-heart");
            button.textContent = " Add to Favorites";
          }
          // Prepend the icon
          button.insertAdjacentHTML(
            "afterbegin",
            `<i class="bi bi-heart${data.isFavorite ? "-fill" : ""}"></i>`
          );
        }
      } catch (err) {
        console.error("Error toggling favorite:", err);
      }
    }
  </script>
</body>

```

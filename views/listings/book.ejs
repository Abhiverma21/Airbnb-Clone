<% layout("/layouts/boilerplate") -%>

<style>
  body {
    background: #f8f9fa;
    font-family: "Poppins", sans-serif;
  }

  .booking-container {
    display: flex;
    flex-wrap: wrap;
    max-width: 1200px;
    margin: 60px auto;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    animation: fadeIn 0.7s ease-in-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Left (Info + Form) */
  .booking-left {
    flex: 0 0 60%;
    padding: 2rem;
    border-right: 1px solid #ddd;
    background-color: #fff;
  }

  .booking-header {
    background: linear-gradient(135deg, #ff5a5f, #e61e4d);
    color: white;
    padding: 1.5rem;
    text-align: center;
    border-radius: 12px;
    margin-bottom: 1.5rem;
  }

  .booking-header h1 {
    font-size: 1.8rem;
    font-weight: 700;
  }

  .listing-info {
    display: flex;
    flex-wrap: wrap;
    gap: 1.2rem;
    align-items: center;
  }

  .listing-info img {
    width: 100%;
    max-width: 280px;
    border-radius: 10px;
    object-fit: cover;
    transition: transform 0.3s ease-in-out;
  }

  .listing-info img:hover { transform: scale(1.02); }

  .listing-details { flex: 1; }
  .listing-details h2 { font-weight: 600; }

  .booking-form {
    margin-top: 1.5rem;
  }

  label { font-weight: 500; margin-top: 10px; }

  .total {
    font-size: 1.3rem;
    font-weight: 600;
    color: #ff385c;
    margin-top: 15px;
  }

  /* Right (Payment) */
  .booking-right {
    flex: 0 0 40%;
    padding: 2rem;
    background: #fff5f7;
    align-items: center;
  }

  #payment-section {
    background: #fff;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    animation: fadeInUp 0.6s ease;
    align-items: center;
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .payment-box {
    transition: all 0.3s ease-in-out;
    cursor: pointer;
    border: 2px solid transparent;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 8px;
  }

  .payment-box.active { border-color: #ff385c; background: #fff0f3; }
  .payment-box:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }

  .payment-details input {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    font-size: 0.95rem;
    width: 100%;
    margin-top: 5px;
  }

  .btn-pay {
    background-color: #ff385c;
    color: white;
    font-weight: 600;
    padding: 10px 25px;
    border: none;
    border-radius: 8px;
    transition: all 0.3s;
    width: 100%;
    margin-top: 1rem;
  }

  .btn-pay:hover { background-color: #e61e4d; }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 999;
    inset: 0;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    animation: popIn 0.4s ease;
  }

  @keyframes popIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  .modal-content h3 { color: #28a745; font-weight: 700; margin-bottom: 15px; }

  .modal-content button {
    margin-top: 1rem;
    background-color: #ff385c;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
  }

  .modal-content button:hover { background-color: #e61e4d; }

  @media screen and (max-width: 900px) {
    .booking-container { flex-direction: column; }
    .booking-left, .booking-right { flex: 100%; border: none; }
  }
</style>

<div class="booking-container">
  <!-- Left Side (Info + Form) -->
  <div class="booking-left">
    <div class="booking-header">
      <h1>Book Your Stay</h1>
      <p>Enjoy your experience at <b><%= listing.title %></b></p>
    </div>

    <div class="listing-info">
      <img src="<%= listing.image.url %>" alt="<%= listing.title %>" />
      <div class="listing-details">
        <h2><%= listing.title %></h2>
        <p><%= listing.description %></p>
        <p>üìç <%= listing.location %>, <%= listing.country %></p>
        <p>üí∞ ‚Çπ<%= listing.price.toLocaleString("en-IN") %> / night</p>
      </div>
    </div>

    <form class="booking-form" id="bookingForm">
      <div class="row">
        <div class="col-md-6">
          <label for="checkin">Check-In:</label>
          <input type="date" id="checkin" required class="form-control" />
        </div>
        <div class="col-md-6">
          <label for="checkout">Check-Out:</label>
          <input type="date" id="checkout" required class="form-control" />
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-md-6">
          <label for="guests">Guests:</label>
          <input type="number" id="guests" min="1" value="1" class="form-control" required />
        </div>
        <div class="col-md-6">
          <label for="email">Email:</label>
          <input type="email" id="email" placeholder="you@example.com" class="form-control" required />
        </div>
      </div>

      <label for="name" class="mt-3">Full Name:</label>
      <input type="text" id="name" class="form-control" placeholder="Your name" required />

      <label for="phone" class="mt-3">Phone Number:</label>
      <input type="tel" id="phone" class="form-control" placeholder="+91 9876543210" required />

      <p class="total mt-3">
        Total: ‚Çπ<span id="total-price"><%= listing.price %></span>
      </p>
    </form>
  </div>

  <!-- Right Side (Payment) -->
  <div class="booking-right">
    <div id="payment-section">
      <h3 class="fw-bold text-center mb-4" style="color: #ff385c">üí∞ Payment Options</h3>

      <div class="payment-options">
        <div class="payment-card payment-box active">
          <label>
            <input type="radio" name="payment" value="Card" checked />
            üí≥ Credit / Debit Card
          </label>
          <div class="payment-details" id="card-details">
            <input type="text" placeholder="Card Number" />
            <div class="row">
              <div class="col-6"><input type="text" placeholder="MM/YY" /></div>
              <div class="col-6"><input type="text" placeholder="CVV" /></div>
            </div>
          </div>
        </div>

        <div class="payment-card payment-box">
          <label>
            <input type="radio" name="payment" value="UPI" />
            üè¶ UPI
          </label>
          <div class="payment-details" id="upi-details" style="display:none">
            <input type="text" placeholder="Enter UPI ID" />
          </div>
        </div>

        <div class="payment-card payment-box">
          <label>
            <input type="radio" name="payment" value="PayPal" />
            üåç PayPal
          </label>
          <div class="payment-details" id="paypal-details" style="display:none">
            <input type="email" placeholder="Enter PayPal Email" />
          </div>
        </div>
      </div>

      <button id="payNow" class="btn-pay">
        Proceed to Pay ‚Çπ<span id="total-display"><%= listing.price %></span>
      </button>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal" id="bookingModal">
  <div class="modal-content">
    <h3>üéâ Booking Confirmed!</h3>
    <p>Thank you for booking <b><%= listing.title %></b></p>
    <button id="closeModal">Done</button>
  </div>
</div>

<script>
  const checkin = document.getElementById('checkin');
  const checkout = document.getElementById('checkout');
  const guests = document.getElementById('guests');
  const totalPriceEl = document.getElementById('total-price');
  const totalDisplay = document.getElementById('total-display');
  const payNow = document.getElementById('payNow');
  const modal = document.getElementById('bookingModal');
  const closeModal = document.getElementById('closeModal');

  const pricePerNight = <%= listing.price %>;

  function calculateTotal() {
    const start = new Date(checkin.value);
    const end = new Date(checkout.value);
    const days = (end - start) / (1000*60*60*24);
    const guestCount = Number(guests.value) || 1;
    const total = days > 0 ? days * pricePerNight * guestCount : pricePerNight;
    totalPriceEl.textContent = total.toLocaleString("en-IN");
    totalDisplay.textContent = total.toLocaleString("en-IN");
    return total;
  }

  [checkin, checkout, guests].forEach(el => el.addEventListener('input', calculateTotal));

  document.querySelectorAll('input[name="payment"]').forEach(radio => {
    radio.addEventListener('change', () => {
      document.querySelectorAll('.payment-details').forEach(div => div.style.display='none');
      document.getElementById(radio.value.toLowerCase() + '-details').style.display='block';
      document.querySelectorAll('.payment-box').forEach(box=>box.classList.remove('active'));
      radio.closest('.payment-box').classList.add('active');
    });
  });

  payNow.addEventListener('click', async (e) => {
    e.preventDefault();

    const start = checkin.value;
    const end = checkout.value;
    const guestCount = guests.value;
    const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
    const total = calculateTotal();

    if(!start || !end) return alert("Please select check-in and check-out dates!");

    try {
      const res = await fetch('/api/bookings', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          listing: "<%= listing._id %>",
          checkin:start,
          checkout:end,
          guests:guestCount,
          paymentMethod,
          total
        })
      });
      const data = await res.json();
      if(!data.success) return alert("Booking failed: "+data.error);

      modal.style.display = 'flex';
    } catch(err) {
      alert("Error: " + err.message);
    }
  });

  closeModal.addEventListener('click', ()=> window.location.href='/listings');
  window.addEventListener('click', (e)=>{ if(e.target === modal) window.location.href='/listings'; });
</script>
